; =====================================================
; Supervisor Configuration for Laravel Queue Worker
; =====================================================
; This file configures Supervisor to manage Laravel queue workers
; ensuring they run continuously and restart automatically if they fail.
;
; Installation Instructions:
; 1. Install Supervisor: sudo apt-get install supervisor
; 2. Copy this file to: /etc/supervisor/conf.d/laravel-queue-worker.conf
; 3. Update paths and user to match your production environment
; 4. Reload Supervisor:
;    sudo supervisorctl reread
;    sudo supervisorctl update
;    sudo supervisorctl start laravel-queue-worker:*
;
; Commands:
; - Start:   sudo supervisorctl start laravel-queue-worker:*
; - Stop:    sudo supervisorctl stop laravel-queue-worker:*
; - Restart: sudo supervisorctl restart laravel-queue-worker:*
; - Status:  sudo supervisorctl status
; =====================================================

[program:laravel-queue-worker]
; The command to run - update the path to your Laravel project
command=php /var/www/html/laravel-app/artisan queue:work redis --sleep=3 --tries=3 --max-time=3600 --timeout=300

; Run as the web server user (e.g., www-data, nginx, or your deployment user)
user=www-data

; Number of worker processes to run (adjust based on your server capacity)
numprocs=4
process_name=%(program_name)s_%(process_num)02d

; Automatically restart the worker if it exits unexpectedly
autorestart=true

; Number of seconds to wait before considering the worker started successfully
startsecs=10

; Number of restart attempts before giving up
startretries=3

; How long to wait for a graceful stop before killing the process
stopwaitsecs=60

; Send stop signal to the whole process group
stopasgroup=true

; Kill the whole process group on stop
killasgroup=true

; Redirect output to log files
stdout_logfile=/var/www/html/laravel-app/storage/logs/queue-worker.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5

stderr_logfile=/var/www/html/laravel-app/storage/logs/queue-worker-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5

; Priority (lower number = higher priority)
priority=999

; =====================================================
; NOTES:
; =====================================================
; 1. Update the 'command' path to match your production Laravel installation
; 2. Update the 'user' to match your web server user or deployment user
; 3. Update the log file paths if your project is in a different location
; 4. Adjust 'numprocs' based on your queue load and server resources
; 5. The --max-time=3600 option restarts workers every hour to prevent memory leaks
; 6. The --timeout=300 option sets a 5-minute timeout for each job
; 7. The --tries=3 option allows jobs to be retried up to 3 times on failure
;
; Queue Connection:
; - This config uses 'redis' queue connection (ensure QUEUE_CONNECTION=redis in .env)
; - For other connections, change 'redis' to 'database', 'sqs', etc.
;
; Monitoring:
; - Check worker status: sudo supervisorctl status laravel-queue-worker:*
; - View logs: tail -f /var/www/html/laravel-app/storage/logs/queue-worker.log
;
; Performance:
; - For high-traffic applications, increase 'numprocs' to 8 or more
; - Monitor memory usage and adjust --max-time if needed
; - Consider using multiple queues with different priorities
; =====================================================
